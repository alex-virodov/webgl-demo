<html>

<head>
    <meta content="text/html;charset=utf-8" http-equiv="Content-Type">
    <meta content="utf-8" http-equiv="encoding">

    <script language="javascript" src="jquery-1.11.3.js"></script>
    <script language="javascript" src="jquery-ui-1.11.3.js"></script>
	
	<script language="javascript">
		$(document).ready(function() {
		
			queue = (function(jqueue, cssClass) {
			
				var queue = [];
				var counter = 0; // for debug
				
				var widthQueue = jqueue.width();
				
				// Get element width by adding to the container and immediately removing
				var widthElem  =  (function() { 
					var elem = $('<div/>').addClass(cssClass).hide().appendTo(jqueue);
					var width = elem.outerWidth();
					elem.remove();
					return width;
				})();

				var allowPopDuringAnimation = false;
				var isPopAnimation = false;

				// no support for insert positon at zero - just 1 and on
				var insertPosition = 0;
				
				function recomputePosition()
				{
					for (var i in queue) {
						var newPosition;
						if (insertPosition > 0 && i >= insertPosition) {
							newPosition = widthQueue - widthElem * ((+i) + 1 + 1);
						} else {
							newPosition = widthQueue - widthElem * ((+i) + 1);
						}
						
						queue[i].positionChanged = /*true if*/(queue[i].position != newPosition);
						queue[i].position = newPosition;
						
						// console.log("widthQueue=", widthQueue, " widthElem=", widthElem, " i=", i, " position=", queue[i].position, "typeof i", typeof i);
					}
				}
				
				function setInsertPosition(pos) {
					insertPosition = pos;
					recomputePosition();
					$.each(queue, function() {
						if (this.positionChanged) {
							this.stop(true, false);
							this.animate({left: this.position}, 500);
						}
					});
				}
				
				function setInsertPositionFromOffset(offset) {
					// console.log(jqueue.offset(), offset);
					pos = Math.round(-1+(widthQueue - (offset.left - jqueue.offset().left)) / widthElem);
					setInsertPosition(pos);
				}
				
				function addElement(name, position)
				{
					var element = $("<div class='queueElement'>"+name+"</div>");
					queue.splice(position, 0, element);
					recomputePosition();
					
					element.css("left", element.position);
					jqueue.append(element);
					return element;
				}
				
				function insertAtInsertPosition(name) {
					var position = insertPosition;
					insertPosition = 0;
					addElement(name, position);
				}
				
				
				// todo: make filters so that only draggables marked by this queue are droppable here
				jqueue.droppable( {
					over: function(event, ui) { 
						ui.helper.queueInsertFunction = setInsertPositionFromOffset;
					},
					
					out: function(event, ui) {
						ui.helper.queueInsertFunction = undefined;
						setInsertPosition(0);
					},
					
					drop: function(event, ui) {
						insertAtInsertPosition(ui.helper.html());
					}
				});
				
				// public interface
				return {
					push: function(name) {
						if (name == undefined) {
							name = counter++;
						}
						
						addElement(name, /*position=*/queue.length);
					},
					
					pop: function() {
						if (!allowPopDuringAnimation && isPopAnimation) { return null; }
					
						var popped = queue.shift();
						
						if (popped) {
							recomputePosition();
							isPopAnimation = true;
							popped.fadeOut(500, function() { popped.remove(); isPopAnimation = false; });
							
							$.each(queue, function() {
								this.animate({left: this.position}, 500);
							});
						}
					},
					
					makeDraggable: function(jelement) {
						jelement.draggable({ 
							helper: "clone", 
							// refreshPositions: true,
							drag: function(event, ui) {
								if (ui.helper.queueInsertFunction) {
									ui.helper.queueInsertFunction(ui.offset);
								}
							},
						});
					}
				};
			})($('#queue'), 'queueElement');
			
			queue.push();
			queue.push();
			queue.push();
			queue.push();
			queue.push();
			queue.push();
			queue.push();
			
			$('#btnPop').click(function() { queue.push(); queue.pop(); });
			
			queue.makeDraggable($('#source'));

			// setInterval(function() { queue.push(); queue.pop(); }, 600);
			
		});
	
	</script>
	
	<style>
		#queue { 
			border:1px solid red;
			width: 600px;
			height: 200px;
			overflow: hidden;
			position: relative;
		}
		
		.queueElement {
			border:1px solid blue;
			display:inline-block;
			width: 80px;
			height: 80px;
			position:absolute;
			padding: 10px;
		}
	</style>
</head>
<body>
	<div id="queue"></div>
	<div id="source" class="queueElement" style="border:1px solid green; position:relative">custom</div>

	<input type="button" id="btnPop" value="pop!">

</body>
</html>
